version: '3.8'

services:
    homeassistant:
        container_name: homeassistant
        # linuxver.io image does some linux/docker magic to allow
        # for the container to run unpriveleged as opposed to the
        # official home assistant docker image
        image: "lscr.io/linuxserver/homeassistant:2023.7.2"
        volumes:
            # Home assistant config dir, mostly auto generated by clicking in the UI
            # Also includes database for some features
            - ./config:/config
            # mount hand editable config file into the path home assistant will look for it
            - ./configuration.yaml:/config/configuration.yaml
            # secrets yaml file that is gitignored
            - ./secrets.yaml:/config/secrets.yaml
            # So home assistant knows what time it is locally
            - /etc/localtime:/etc/localtime:ro
            # output dir for home assistant when capturing pictures/videos from home cameras
            - ./media:/media
        devices:
            # mount the zigbee radio USB stick as a device so home assistant can use it
            - /dev/ttyACM0:/dev/ttyACM0
        restart: unless-stopped
        # home assistant image has to run on 'host' network mode to allow it to talk to
        # wifi devices in the house.
        # Because it has to run in this network mode traefik cannot auto wire this
        # container up to the reverse proxy using docker tags. So instead
        # home assistant config can be found in the traefik repository
        # https://github.com/RileyMathews/home-server-traefik/blob/master/etc/traefik/file_providers/file-provider-homeassistant.yml#L4
        network_mode: host
        environment:
            - PUID=1000
            - PGID=1000
